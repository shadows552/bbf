# ModSecurity configuration for BBF application

# Enable ModSecurity
SecRuleEngine On

# Request body handling
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# Response body handling
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# File upload handling
SecTmpDir /tmp/
SecDataDir /tmp/
SecUploadDir /tmp/

# Debug log
SecDebugLog /var/log/modsec_debug.log
SecDebugLogLevel 0

# Audit log
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec_audit.log

# Argument separator
SecArgumentSeparator &

# Cookie format
SecCookieFormat 0

# Unicode map
SecUnicodeMapFile unicode.mapping 20127

# Collection timeout
SecCollectionTimeout 600

# PCRE limits
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000

# Buffer overflow protection
SecRequestBodyJsonDepthLimit 512

# Load OWASP Core Rule Set
Include /etc/modsecurity.d/owasp-crs/crs-setup.conf
Include /etc/modsecurity.d/owasp-crs/rules/*.conf

# Custom rules for BBF application
SecRule REQUEST_HEADERS:Content-Type "(?:application/json)" \
    "id:200001,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:requestBodyProcessor=JSON"

# Block SQL injection attempts
SecRule ARGS "@detectSQLi" \
    "id:200002,\
    phase:2,\
    block,\
    log,\
    msg:'SQL Injection Attack Detected',\
    severity:CRITICAL,\
    tag:'application-multi',\
    tag:'language-sql',\
    tag:'attack-sqli'"

# Block XSS attempts
SecRule ARGS "@detectXSS" \
    "id:200003,\
    phase:2,\
    block,\
    log,\
    msg:'XSS Attack Detected',\
    severity:CRITICAL,\
    tag:'application-multi',\
    tag:'language-javascript',\
    tag:'attack-xss'"

# Rate limiting rule (complement to nginx rate limiting)
SecAction \
    "id:200004,\
    phase:1,\
    nolog,\
    pass,\
    initcol:ip=%{REMOTE_ADDR},\
    setvar:ip.requests=+1,\
    expirevar:ip.requests=60"

SecRule IP:REQUESTS "@gt 100" \
    "id:200005,\
    phase:1,\
    block,\
    log,\
    msg:'Rate limit exceeded - More than 100 requests per minute',\
    severity:WARNING"

# Block user agents commonly used by scanners
SecRule REQUEST_HEADERS:User-Agent "@pmFromFile /etc/modsecurity.d/scanner-user-agents.data" \
    "id:200006,\
    phase:1,\
    block,\
    log,\
    msg:'Security Scanner Detected',\
    severity:WARNING"

# Validate JSON for API endpoints
SecRule REQUEST_URI "@beginsWith /api/" \
    "id:200007,\
    phase:2,\
    chain,\
    log,\
    pass"
    SecRule REQUEST_HEADERS:Content-Type "!@contains application/json" \
        "t:none,\
        msg:'Invalid Content-Type for API endpoint',\
        severity:WARNING"
