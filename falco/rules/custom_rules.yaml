---
# Custom Falco rules for BBF application security monitoring

- rule: Unauthorized Process Execution in Container
  desc: Detect execution of unauthorized processes in application containers
  condition: >
    spawned_process and
    container and
    container.name in (bbf-backend, bbf-frontend) and
    not proc.name in (node, nginx)
  output: >
    Unauthorized process started in container
    (user=%user.name command=%proc.cmdline container=%container.name
    image=%container.image.repository:%container.image.tag)
  priority: WARNING
  tags: [container, process, bbf]

- rule: Sensitive File Access in Container
  desc: Detect attempts to access sensitive files
  condition: >
    open_read and
    container and
    container.name in (bbf-backend, bbf-frontend) and
    fd.name in (/etc/shadow, /etc/passwd, /root/.ssh/id_rsa, /.env)
  output: >
    Sensitive file accessed
    (user=%user.name file=%fd.name command=%proc.cmdline
    container=%container.name image=%container.image.repository)
  priority: CRITICAL
  tags: [filesystem, container, bbf]

- rule: Network Connection to Suspicious Port
  desc: Detect network connections to non-standard ports
  condition: >
    outbound and
    container and
    container.name in (bbf-backend, bbf-frontend) and
    not fd.sport in (80, 443, 3000, 3100, 8080, 8181, 9080) and
    not fd.dport in (80, 443, 3000, 3100, 8080, 8181, 9080)
  output: >
    Suspicious network connection detected
    (user=%user.name connection=%fd.name sport=%fd.sport dport=%fd.dport
    container=%container.name)
  priority: WARNING
  tags: [network, container, bbf]

- rule: Shell Spawned in Container
  desc: Detect interactive shell spawned in application container
  condition: >
    spawned_process and
    container and
    container.name in (bbf-backend, bbf-frontend) and
    proc.name in (bash, sh, ash, zsh, csh, ksh)
  output: >
    Shell spawned in application container (potential security incident)
    (user=%user.name shell=%proc.name parent=%proc.pname
    cmdline=%proc.cmdline container=%container.name)
  priority: CRITICAL
  tags: [shell, container, bbf]

- rule: Cryptomining Activity Detected
  desc: Detect potential cryptomining processes
  condition: >
    spawned_process and
    container and
    proc.name in (minerd, xmrig, ethminer, cpuminer)
  output: >
    Potential cryptomining detected
    (user=%user.name command=%proc.cmdline container=%container.name)
  priority: CRITICAL
  tags: [malware, container, bbf]

- rule: Package Manager Execution in Container
  desc: Detect package manager execution (potential supply chain attack)
  condition: >
    spawned_process and
    container and
    container.name in (bbf-backend, bbf-frontend) and
    proc.name in (npm, pip, apt, apk, yum, dnf)
  output: >
    Package manager executed in running container (should be build-time only)
    (user=%user.name command=%proc.cmdline container=%container.name)
  priority: WARNING
  tags: [package, container, bbf]

- rule: Write to System Directories
  desc: Detect writes to system directories
  condition: >
    open_write and
    container and
    container.name in (bbf-backend, bbf-frontend) and
    fd.name startswith /bin or
    fd.name startswith /sbin or
    fd.name startswith /usr/bin or
    fd.name startswith /usr/sbin
  output: >
    Write to system directory detected
    (user=%user.name file=%fd.name command=%proc.cmdline
    container=%container.name)
  priority: CRITICAL
  tags: [filesystem, container, bbf]
